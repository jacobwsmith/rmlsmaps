"use strict";var rmlsmapsApp=angular.module("rmlsmapsApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/list",{templateUrl:"views/list.html",controller:"ListCtrl"}).when("/map",{templateUrl:"views/map.html",controller:"MapCtrl"}).when("/temp",{templateUrl:"views/temp.html"}).otherwise({redirectTo:"/"})}]);rmlsmapsApp.factory("sharedService",["$rootScope",function(){var a={};return a.listings=[],a.isLoading=!0,a.listings=[{address:"2732 NE 51st Ave",city:"Portland",zip:"97213",price:"$999,999",gAddress:"2732+NE+51st+Ave,+Portland,+97213",lat:45.542483,lng:-122.61037599999997,bb:"3/2",sqft:2e3,built:1928,imageList:["http://www.rmlsweb.com/WEBPHOTOS/14300000/80000/5000/14385576-7.jpg","http://www.rmlsweb.com/WEBPHOTOS/14300000/80000/5000/14385576-8.jpg","http://www.rmlsweb.com/WEBPHOTOS/14300000/80000/5000/14385576-9.jpg"]},{address:"3106 NE 31st Ave",city:"Portland",zip:"97212",price:"$699,999",gAddress:"3106+NE+31st+Ave,+Portland,+97212",lat:45.5454681,lng:-122.6337034,bb:"2/1",sqft:2e3,built:1922,imageList:["http://www.rmlsweb.com/WEBPHOTOS/14300000/80000/5000/14385576-4.jpg","http://www.rmlsweb.com/WEBPHOTOS/14300000/80000/5000/14385576-5.jpg","http://www.rmlsweb.com/WEBPHOTOS/14300000/80000/5000/14385576-6.jpg"]}],a}]),angular.module("rmlsmapsApp").controller("MainCtrl",["$scope","$location","sharedService",function(a,b,c){a.name="",a.init=function(){c.isLoading=!1},a.example=function(){console.log("click"),a.name="http://rmlsmaps.jacobwsmith.com/example.html",a.onButtonClick()},a.showLoading=function(){return c.isLoading},a.onButtonClick=function(){c.isLoading=!0,$.ajax({url:a.name,type:"get",dataType:"",success:function(b){var c;c=b.responseText,a.setListings(c)},error:function(a){alert("An Error has occured"),c.isLoading=!1,console.log("=== error ==="),console.log(a)}})},a.setListings=function(d){try{var e=function(a){return a.replace(/ /g,"+")};c.listings=[],$.each($(d).find(".V2_REPORT_SUBREPORT > table"),function(a){var b=a;c.listings.push({});var d=$(this).find(".PHOTO").attr("src");d=d.slice(0,d.lastIndexOf("/")+1),c.listings[b].imageList=[],$(this).find('[id^="PHOTONAV"]').each(function(){var a=$(this).context.id;a=a.replace("_",""),a=a.replace("_","-"),a=a.slice(a.indexOf("PHOTONAV_")+9),a="http://www.rmlsweb.com"+d+a+".jpg",c.listings[b].imageList.push(a)}),$(this).find(".V2_REPORT_ROW").each(function(a){if(0===a)c.listings[b].mls=$(this).find("td:eq(1) p").html().trim(),c.listings[b].status=$(this).find("td:eq(5) p").html().trim(),c.listings[b].price=$(this).find("td:last p").html().trim();else if(1===a){c.listings[b].address=$(this).find("td:eq(1) p").html().trim();var d=c.listings[b].address.indexOf("<a");-1!==d&&(c.listings[b].address=c.listings[b].address.slice(0,d).trim()),c.listings[b].city=$(this).find("td:eq(3) > a").html().trim(),c.listings[b].zip=$(this).find("td:eq(5) p").html().trim()}else 3===a&&(c.listings[b].bb=$(this).find("td:eq(1) p").html().trim(),c.listings[b].sqft=$(this).find("td:eq(3) p").html().trim(),c.listings[b].built=$(this).find("td:eq(5) p").html().trim())}),c.listings[b].gAddress=e(c.listings[b].address+", "+c.listings[b].city+", "+c.listings[b].zip)}),c.listings.length>0?a.$apply(function(){b.path("/list")}):alert("No records found")}catch(f){a.setListings2(d)}},a.setListings2=function(d){try{console.log("setListings2");var e=function(a){return a.replace(/ /g,"+")};c.listings=[],$.each($(d).find(".V2_REPORT_PHOTOTABLE"),function(a){console.log(".V2_REPORT_PHOTOTABLE: "+a);var b=a;c.listings.push({});var f=$(this).find(".PHOTO").attr("src");f=f.slice(0,f.lastIndexOf("/")+1),c.listings[b].imageList=[],$(this).find('[id^="PHOTONAV"]').each(function(){var a=$(this).context.id;a=a.replace("_",""),a=a.replace("_","-"),a=a.slice(a.indexOf("PHOTONAV_")+9),a="http://www.rmlsweb.com"+f+a+".jpg",c.listings[b].imageList.push(a)}),$(this).find(".V2_REPORT_ROW").each(function(a){if(3===a)c.listings[b].status=$(this).find("td:eq(2)").text().trim();else if(4===a)c.listings[b].mls=$(this).find("td:eq(1)").text().trim(),c.listings[b].price=$(this).find("td:eq(5)").text().trim();else if(5===a){c.listings[b].address=$(this).find("td:eq(1)").text().trim();var d=c.listings[b].address.indexOf("<a");-1!==d&&(c.listings[b].address=c.listings[b].address.slice(0,d).trim())}else 6===a&&(c.listings[b].city=$(this).find("td:eq(1) > a").text().trim(),c.listings[b].zip=$(this).find("td:eq(3)").text().trim())}),c.listings[b].beds=$(d).find(".REPORT_STDBOX:eq("+b+")").find(".V2_REPORT_SUBREPORT:eq(2)").find(".V2_REPORT_ROW:eq(0)").find("td:eq(5)").text().trim(),c.listings[b].baths=$(d).find(".REPORT_STDBOX:eq("+b+")").find(".V2_REPORT_SUBREPORT:eq(2)").find(".V2_REPORT_ROW:eq(0)").find("td:eq(7)").text().trim(),c.listings[b].bb=c.listings[b].beds.replace("/",".")+"/"+c.listings[b].baths.replace("/","."),c.listings[b].sqft=$(d).find(".REPORT_STDBOX:eq("+b+")").find(".V2_REPORT_SUBREPORT:eq(2)").find(".V2_REPORT_ROW:eq(3)").find("td:eq(1)").text().trim(),c.listings[b].built=$(d).find(".REPORT_STDBOX:eq("+b+")").find(".V2_REPORT_SUBREPORT:eq(2)").find(".V2_REPORT_ROW:eq(0)").find("td:eq(11)").text().trim();var g=c.listings[b].built.indexOf("/");-1!==g&&(c.listings[b].built=c.listings[b].built.slice(0,g).trim()),c.listings[b].gAddress=e(c.listings[b].address+", "+c.listings[b].city+", "+c.listings[b].zip)}),c.listings.length>0?a.$apply(function(){b.path("/list")}):alert("No records found")}catch(f){alert("Sorry, the system is unable to parse your report. Please contact the admin with the report url."),console.log(f.message),c.isLoading=!1}}}]),jQuery.ajax=function(a){function b(a){return!e.test(a)&&/:\/\//.test(a)}var c=location.protocol,d=location.hostname,e=RegExp(c+"//"+d),f="http"+(/^https/.test(c)?"s":"")+"://query.yahooapis.com/v1/public/yql?callback=?",g='select * from html where url="{URL}" and xpath="*"';return function(c){var d=c.url;return/get/i.test(c.type)&&!/json/i.test(c.dataType)&&b(d)&&(c.url=f,c.dataType="json",c.data={q:g.replace("{URL}",d+(c.data?(/\?/.test(d)?"&":"?")+jQuery.param(c.data):"")),format:"xml"},!c.success&&c.complete&&(c.success=c.complete,delete c.complete),c.success=function(a){return function(b){a&&a.call(this,{responseText:(b.results[0]||"").replace(/<script[^>]+?\/>|<script(.|\s)*?\/script>/gi,"")},"success")}}(c.success)),a.apply(this,arguments)}}(jQuery.ajax),angular.module("rmlsmapsApp").controller("ListCtrl",["$scope","$location","sharedService",function(a,b,c){a.count=0,a.listings=c.listings,a.init=function(){c.isLoading=!1},a.showLoading=function(){return c.isLoading},a.submit=function(){c.isLoading=!0,c.listings.length<1?b.path("/"):a.getLatLng()},a.getLatLng=function(){var b=new google.maps.Geocoder;"function"==typeof b.geocode?b.geocode({address:c.listings[a.count].gAddress},function(b,c){c==google.maps.GeocoderStatus.OK?a.callback(b[0]):(alert("Geocode was not successful for the following reason: "+c),a.callback({}))}):alert("Google geocoder not working")},a.callback=function(d){c.listings[a.count].geocode=d,c.listings[a.count].lat=d.geometry.location.lat(),c.listings[a.count].lng=d.geometry.location.lng(),a.count++,a.count===c.listings.length?a.$apply(function(){b.path("/map")}):a.getLatLng()},a.cancel=function(){b.path("/")}}]),angular.module("rmlsmapsApp").controller("MapCtrl",["$scope","$location","sharedService",function(a,b,c){a.isMax="display:none;",a.isMin="display:block;",a.panelWidth="",a.panelHeight="",a.mapMargin="",a.listings=c.listings,a.activeListing={bb:"bb",address:"address",zip:"zip",city:"city",sqft:"sqft",built:"built",price:"price",imageList:["http://www.rmlsweb.com/WEBPHOTOS/14300000/80000/5000/14385576-1.jpg"]},a.init=function(){a.buildMap()},a.showLoading=function(){return c.isLoading},a.buildMap=function(){function b(b){var c=new google.maps.Marker({position:new google.maps.LatLng(b.lat,b.lng),map:e,title:b.address});g.push(b);var d,f=document.createElement("div");d=$("<div>").addClass("row").append($("<div>").addClass("col-xs-6").append($("<span>").addClass("pointer").attr("data-toggle","modal").attr("data-target",".bs-example-modal-lg").click(function(){a.activeListing=b,a.$apply(),document.getElementById("streetView").innerHTML="Loading...",setTimeout(function(){{var a=document.getElementById("streetView");new google.maps.StreetViewPanorama(a,{navigationControl:!0,enableCloseButton:!1,addressControl:!1,linksControl:!1,visible:!0,position:c.getPosition()})}},250)}).html('<img src="'+b.imageList[0]+'" width="100"><br>View Details')),$("<div>").addClass("col-xs-6").append(b.address+"<br>Price: "+b.price+"<br>Beds/Bths: "+b.bb+"<br>Sqft: "+b.sqft+"<br>Built: "+b.built)),$(f).append(d);var h=new google.maps.InfoWindow({content:f});google.maps.event.addListener(c,"click",function(){h.open(e,c)}),google.maps.event.addListenerOnce(h,"domready",function(){})}function d(){try{var a=new google.maps.LatLngBounds;for(index in g){var b=g[index];0!=b.lat&&0!=b.lng&&a.extend(new google.maps.LatLng(b.lat,b.lng))}e.fitBounds(a)}catch(c){console.log(c.message)}}var e,f,g,h;if(c.listings.length<1)$("#map").html("No Records Found. Try re-submiting your request."),c.isLoading=!1;else{for(f={mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1},e=new google.maps.Map(document.getElementById("map"),f),g=[],h=0;h<c.listings.length;h++)b(c.listings[h]);d(),c.isLoading=!1}},a.showLeftPanel=function(){a.isMax="",a.isMin="display:none;",a.panelWidth="width:300px;",a.panelHeight="height:100%;",a.mapMargin="margin-left:300px;"},a.hideLeftPanel=function(){a.isMax="display:none;",a.isMin="",a.panelWidth="",a.panelHeight="",a.mapMargin=""}}]);